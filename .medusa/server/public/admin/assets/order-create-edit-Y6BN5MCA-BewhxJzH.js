import{M as z}from"./chunk-NNBHHXXN-CuEJbOOV.js";import{b as U,u as H,c as L,d as F,e as B,f as V,g as J}from"./chunk-HGTYIREL-Ct7xH8am.js";import{D as Q}from"./chunk-D4T3GFML-k03o88f9.js";import{a as S}from"./chunk-PDWBYQOW-Dmlh1vBq.js";import{P as $,a as G}from"./chunk-IQBAUTU5-DO3CwvnN.js";import{W as K,u as X,b as v,b1 as W,b2 as Y,r as g,j as e,t as p,ad as Z,ae as ee,a7 as se,H as D,w as h,I as q,ag as te,B as I,a8 as ae,a9 as re,dU as ne,aL as ie,J as A,a0 as T,A as le,dV as de,b8 as oe,aq as ce,f as ue}from"./index-ozeXIKHB.js";import{u as me,_ as xe}from"./chunk-B2JT2FOA-ClytpOI7.js";import"./chunk-GJUPECDU-BzFLSLeH.js";import{u as fe}from"./chunk-C76H5USB-DdCB11cb.js";import{K as pe}from"./chunk-6HTZNHPT-Dh7Pdro1.js";import{R as b,u as he,a as je,S as _}from"./chunk-4TC5YS65-CRTXVCux.js";import{u as ge}from"./use-prompt-IWkqzt5o.js";import{C as P}from"./checkbox-_eU08wVq.js";import"./chunk-P3UUX2T6-BIhVcxhd.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-YEDAFXMB-dVu5MMzv.js";import"./chunk-M3VFKDXJ-D4AM4tlF.js";import"./chunk-AOFGTNG6-4Yn5wtXn.js";import"./table-BKEDbZOL.js";import"./chunk-EMIHDNB7-B6-fh2oC.js";import"./command-bar-CqLJlmwN.js";import"./chunk-PFKKVLZX-8a2WXjA-.js";import"./_isIndex-mOlik3oL.js";import"./date-picker-ChsOIlAB.js";import"./popover-BY8PlgN4.js";import"./triangle-left-mini-DWPX0Ub-.js";import"./prompt-BnErB-By.js";var C=ue(),ye=s=>{const{t:l}=v();return g.useMemo(()=>[C.display({id:"select",header:({table:t})=>e.jsx(P,{checked:t.getIsSomePageRowsSelected()?"indeterminate":t.getIsAllPageRowsSelected(),onCheckedChange:r=>t.toggleAllPageRowsSelected(!!r)}),cell:({row:t})=>{const r=t.getCanSelect();return e.jsx(P,{disabled:!r,checked:t.getIsSelected(),onCheckedChange:a=>t.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),C.display({id:"product",header:()=>e.jsx(G,{}),cell:({row:t})=>e.jsx($,{product:t.original.product})}),C.accessor("sku",{header:l("fields.sku"),cell:({getValue:t})=>t()||"-"}),C.accessor("title",{header:l("fields.title")})],[l,s])},be=()=>{const{t:s}=v();return[{key:"created_at",label:s("fields.createdAt"),type:"date"},{key:"updated_at",label:s("fields.updatedAt"),type:"date"}]},ve=({pageSize:s=50,prefix:l})=>{const t=fe(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:u,...m}=t;return{searchParams:{...m,limit:s,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:u?JSON.parse(u):void 0},raw:t}},k=50,R="rit",Ne=({onSelectionChange:s,currencyCode:l})=>{const{t}=v(),[r,a]=g.useState({}),u=o=>{const N=typeof o=="function"?o(r):o;a(N),s(Object.keys(N))},{searchParams:m,raw:x}=ve({pageSize:k,prefix:R}),{variants:y=[],count:f}=ne({...m,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),n=ye(l),w=be(),{table:j}=me({data:y,columns:n,count:f,enablePagination:!0,getRowId:o=>o.id,pageSize:k,enableRowSelection:o=>!0,rowSelection:{state:r,updater:u}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(xe,{table:j,columns:n,pageSize:k,count:f,filters:w,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:t("fields.product")},{key:"title",label:t("fields.title")},{key:"sku",label:t("fields.sku")}],prefix:R,queryObject:x})})};function we({item:s,currencyCode:l,orderId:t}){const{t:r}=v(),{mutateAsync:a}=F(t),{mutateAsync:u}=B(t),{mutateAsync:m}=V(t),{mutateAsync:x}=J(t),y=g.useMemo(()=>{var i;return!!((i=s.actions)!=null&&i.find(d=>d.action==="ITEM_ADD"))},[s]),f=g.useMemo(()=>{var i;return!!((i=s.actions)!=null&&i.find(d=>d.action==="ITEM_UPDATE"))},[s]),n=g.useMemo(()=>{var d;return!!((d=s.actions)==null?void 0:d.find(c=>c.action==="ITEM_UPDATE"))&&s.quantity===s.detail.fulfilled_quantity},[s]),w=async i=>{var c;if(i<=s.detail.fulfilled_quantity){p.error(r("orders.edits.validation.quantityLowerThanFulfillment"));return}if(i===s.quantity)return;const d=(c=s.actions)==null?void 0:c.find(E=>E.action==="ITEM_ADD");try{d?await u({quantity:i,actionId:d.id}):await m({quantity:i,itemId:s.id})}catch(E){p.error(E.message)}},j=async()=>{var d;const i=(d=s.actions)==null?void 0:d.find(c=>c.action==="ITEM_ADD");try{i?await x(i.id):await m({quantity:s.detail.fulfilled_quantity,itemId:s.id})}catch(c){p.error(c.message)}},o=async()=>{var d;const i=(d=s.actions)==null?void 0:d.find(c=>c.action==="ITEM_UPDATE");try{i&&await x(i.id)}catch(c){p.error(c.message)}},N=async()=>{try{await a({items:[{variant_id:s.variant_id,quantity:s.quantity}]})}catch(i){p.error(i.message)}};return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center justify-between",children:[e.jsxs("div",{className:"flex flex-row items-center gap-x-3",children:[e.jsx(ie,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(A,{className:"txt-small",as:"span",weight:"plus",children:[s.title," "]}),s.variant_sku&&e.jsxs("span",{children:["(",s.variant_sku,")"]})]}),e.jsx(A,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.subtitle})]})]}),y&&e.jsx(T,{size:"2xsmall",rounded:"full",color:"blue",className:"mr-1",children:r("general.new")}),n?e.jsx(T,{size:"2xsmall",rounded:"full",color:"red",className:"mr-1",children:r("general.removed")}):f&&e.jsx(T,{size:"2xsmall",rounded:"full",color:"orange",className:"mr-1",children:r("general.modified")})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(q,{className:"bg-ui-bg-base txt-small w-[67px] rounded-lg [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",disabled:s.detail.fulfilled_quantity===s.quantity,min:s.detail.fulfilled_quantity,defaultValue:s.quantity,onBlur:i=>{const d=i.target.value,c=d===""?null:Number(d);c&&w(c)}}),e.jsx(A,{className:"txt-small text-ui-fg-subtle",children:r("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(z,{currencyCode:l,amount:s.total})}),e.jsx(le,{groups:[{actions:[{label:r("actions.duplicate"),onClick:N,icon:e.jsx(de,{})}]},{actions:[n?{label:r("actions.undo"),onClick:o,icon:e.jsx(ce,{})}:{label:r("actions.remove"),onClick:j,icon:e.jsx(oe,{}),disabled:s.detail.fulfilled_quantity===s.quantity}].filter(Boolean)}]})]})]})},s.quantity)}var M=[],_e=({order:s,preview:l})=>{const{t}=v(),{setIsOpen:r}=je(),[a,u]=g.useState(""),{mutateAsync:m,isPending:x}=F(s.id),y=async()=>{await m({items:M.map(n=>({variant_id:n,quantity:1}))},{onError:n=>{p.error(n.message)}}),r("inbound-items",!1)},f=g.useMemo(()=>l.items.filter(n=>n.title.toLowerCase().includes(a)||n.product_title.toLowerCase().includes(a)),[l,a]);return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-3 mt-8 flex items-center justify-between",children:[e.jsx(D,{level:"h2",children:t("fields.items")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{value:a,onChange:n=>u(n.target.value),placeholder:t("fields.search"),autoComplete:"off",type:"search"}),e.jsxs(_,{id:"inbound-items",children:[e.jsx(_.Trigger,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:t("actions.addItems")})}),e.jsxs(_.Content,{children:[e.jsx(_.Header,{}),e.jsx(Ne,{currencyCode:s.currency_code,onSelectionChange:n=>{M=n}}),e.jsx(_.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(b.Close,{asChild:!0,children:e.jsx(I,{type:"button",variant:"secondary",size:"small",children:t("actions.cancel")})}),e.jsx(I,{type:"submit",variant:"primary",size:"small",role:"button",disabled:x,onClick:async()=>await y(),children:t("actions.save")},"submit-button")]})})})]})]})]})]}),f.map(n=>e.jsx(we,{item:n,orderId:s.id,currencyCode:s.currency_code},n.id)),a&&!f.length&&e.jsx("div",{style:{background:"repeating-linear-gradient(-45deg, rgb(212, 212, 216, 0.15), rgb(212, 212, 216,.15) 10px, transparent 10px, transparent 20px)"},className:"bg-ui-bg-field mt-4 block h-[56px] w-full rounded-lg border border-dashed"})]})},Ie=se({note:re().optional(),send_notification:ae().optional()}),Ce=({order:s,preview:l})=>{const{t}=v(),{handleSuccess:r}=he(),{mutateAsync:a,isPending:u}=H(s.id),{mutateAsync:m,isPending:x}=L(s.id),y=u||x,f=Z({defaultValues:()=>Promise.resolve({note:"",send_notification:!1}),resolver:ee(Ie)}),n=ge(),w=f.handleSubmit(async j=>{try{if(!await n({title:t("general.areYouSure"),description:t("orders.edits.confirmText"),confirmText:t("actions.continue"),cancelText:t("actions.cancel"),variant:"confirmation"}))return;await m(),p.success(t("orders.edits.createSuccessToast")),r()}catch(o){p.error(t("general.error"),{description:o.message})}});return e.jsx(b.Form,{form:f,onClose:j=>{j||a(void 0,{onSuccess:()=>{p.success(t("orders.edits.cancelSuccessToast"))},onError:o=>{p.error(o.message)}})},children:e.jsxs(pe,{onSubmit:w,className:"flex h-full flex-col",children:[e.jsx(b.Header,{}),e.jsx(b.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(D,{level:"h1",children:t("orders.edits.create")}),e.jsx(_e,{preview:l,order:s}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:t("orders.edits.currentTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:S(s.total,s.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:t("orders.edits.newTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:S(l.total,s.currency_code)})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:t("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:S(l.summary.pending_difference,s.currency_code)})]})]}),e.jsx(h.Field,{control:f.control,name:"note",render:({field:j})=>e.jsx(h.Item,{children:e.jsxs("div",{className:"mt-8 flex",children:[e.jsxs("div",{className:"block flex-1",children:[e.jsx(h.Label,{children:t("fields.note")}),e.jsx(h.Hint,{className:"!mt-1",children:t("orders.edits.noteHint")})]}),e.jsx("div",{className:"w-full flex-1 flex-grow",children:e.jsx(h.Control,{children:e.jsx(q,{...j,placeholder:t("fields.note")})})})]})})}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(h.Field,{control:f.control,name:"send_notification",render:({field:{onChange:j,value:o,...N}})=>e.jsxs(h.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h.Control,{className:"mr-4 self-start",children:e.jsx(te,{className:"mt-[2px]",checked:!!o,onCheckedChange:j,...N})}),e.jsxs("div",{className:"block",children:[e.jsx(h.Label,{children:t("orders.returns.sendNotification")}),e.jsx(h.Hint,{className:"!mt-1",children:t("orders.returns.sendNotificationHint")})]})]}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(b.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(b.Close,{asChild:!0,children:e.jsx(I,{type:"button",variant:"secondary",size:"small",children:t("orders.edits.cancel")})}),e.jsx(I,{type:"submit",variant:"primary",size:"small",isLoading:y,children:t("orders.edits.confirm")},"submit-button")]})})})]})})},O=!1,es=()=>{const{id:s}=K(),l=X(),{t}=v(),{order:r}=W(s,{fields:Q}),{order:a}=Y(s),{mutateAsync:u}=U(r.id);return g.useEffect(()=>{async function m(){if(!(O||!a)){if(a.order_change){a.order_change.change_type!=="edit"&&(l(`/orders/${a.id}`,{replace:!0}),p.error(t("orders.edits.activeChangeError")));return}O=!0;try{const{order:x}=await u({order_id:a.id})}catch(x){p.error(x.message),l(`/orders/${a.id}`,{replace:!0})}finally{O=!1}}}m()},[a]),e.jsx(b,{children:a&&r&&e.jsx(Ce,{order:r,preview:a})})};export{es as Component};
