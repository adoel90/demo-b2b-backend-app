import{R as S}from"./chunk-3GWR73RY-BgjU9Iat.js";import{W as A,b as _,dK as B,j as t,H as C,dF as D,dL as H,dM as K,dN as L,r as M,ac as N,ad as U,a6 as R,B as v,ah as w,a8 as u,a7 as F,ai as z,aj as T,av as p}from"./index-C_TCY6wF.js";import"./chunk-2PMSBTXI-C-5QcGFZ.js";import{K as V}from"./chunk-6HTZNHPT-C3g-6wSS.js";import{b as m,u as W}from"./chunk-4TC5YS65-C1s3AhWO.js";import"./chunk-HFB3OQXI-hSS3qBmi.js";import"./select-BwAkz2T_.js";import"./triangles-mini-LscvU68w.js";import"./prompt-B3qCXbW-.js";var $=R({type:u().optional(),rules:w(R({id:u().optional(),attribute:u().min(1,{message:p.t("promotions.form.required")}),operator:u().min(1,{message:p.t("promotions.form.required")}),values:z([T().min(1,{message:p.t("promotions.form.required")}),u().min(1,{message:p.t("promotions.form.required")}),w(u()).min(1,{message:p.t("promotions.form.required")})]),required:F().optional(),disguised:F().optional(),field_type:u().optional()}))}),k=({promotion:s,ruleType:f,handleSubmit:n,isSubmitting:r})=>{const{t:d}=_(),[o,a]=M.useState([]),l=N({defaultValues:{rules:[],type:s.type},resolver:U($)}),c=l.handleSubmit(n(o));return t.jsx(m.Form,{form:l,children:t.jsxs(V,{onSubmit:c,className:"flex h-full flex-col",children:[t.jsx(m.Body,{children:t.jsx(S,{form:l,ruleType:f,setRulesToRemove:a,rulesToRemove:o,promotion:s})}),t.jsx(m.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[t.jsx(m.Close,{asChild:!0,children:t.jsx(v,{size:"small",variant:"secondary",disabled:r,children:d("actions.cancel")})}),t.jsx(v,{size:"small",type:"submit",isLoading:r,children:d("actions.save")})]})})]})})},I=s=>s.field_type==="number"?parseInt(s.values):s.values,O=({promotion:s,rules:f,ruleType:n})=>{const{handleSuccess:r}=W(),{mutateAsync:d}=D(s.id),{mutateAsync:o}=H(s.id,n),{mutateAsync:a}=K(s.id,n),{mutateAsync:l,isPending:c}=L(s.id,n),y=i=>async function(h){const g={},{rules:b=[]}=h,E=b.filter(e=>e.disguised),q=(i==null?void 0:i.filter(e=>e.disguised))||[];for(const e of E)g[e.attribute]=I(e);for(const e of q)g[e.attribute]=null;const x=b.filter(e=>!e.disguised),j=x.filter(e=>!("id"in e)),P=x.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),j.length&&await o({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),i!=null&&i.length&&await a({rule_ids:i.map(e=>e.id).filter(Boolean)}),P.length&&await l({rules:P.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),r()};return t.jsx(k,{promotion:s,rules:f,ruleType:n,handleSubmit:y,isSubmitting:c})},ae=()=>{var i,h;const s=A();if(!["rules","buy-rules","target-rules"].includes(s.ruleType))throw"invalid page";const{t:n}=_(),r=s.ruleType,d=s.id,o=[],{promotion:a,isPending:l,isError:c,error:y}=B(d);if(a&&(r==="rules"?o.push(...a.rules||[]):r==="target-rules"?o.push(...((i=a==null?void 0:a.application_method)==null?void 0:i.target_rules)||[]):r==="buy-rules"&&o.push(...((h=a.application_method)==null?void 0:h.buy_rules)||[])),c)throw y;return t.jsxs(m,{children:[t.jsx(m.Header,{children:t.jsx(C,{children:n(`promotions.edit.${r}.title`)})}),!l&&a&&t.jsx(O,{promotion:a,rules:o,ruleType:r})]})};export{ae as Component};
