import{R as S}from"./chunk-3GWR73RY-BSM_Jeqr.js";import{W as A,b as _,e8 as B,j as t,H as C,e3 as D,e9 as H,ea as U,eb as k,r as z,ad as K,ae as L,a7 as R,B as v,ai as w,a9 as u,a8 as F,aj as M,ak as N,ax as p}from"./index-ozeXIKHB.js";import"./chunk-2PMSBTXI-QP7lqZBs.js";import{K as T}from"./chunk-6HTZNHPT-Dh7Pdro1.js";import{b as m,u as V}from"./chunk-4TC5YS65-CRTXVCux.js";import"./chunk-HFB3OQXI-BVC_eQ9Y.js";import"./select-B9mkcMq0.js";import"./prompt-BnErB-By.js";var W=R({type:u().optional(),rules:w(R({id:u().optional(),attribute:u().min(1,{message:p.t("promotions.form.required")}),operator:u().min(1,{message:p.t("promotions.form.required")}),values:M([N().min(1,{message:p.t("promotions.form.required")}),u().min(1,{message:p.t("promotions.form.required")}),w(u()).min(1,{message:p.t("promotions.form.required")})]),required:F().optional(),disguised:F().optional(),field_type:u().optional()}))}),$=({promotion:s,ruleType:f,handleSubmit:n,isSubmitting:r})=>{const{t:d}=_(),[o,a]=z.useState([]),l=K({defaultValues:{rules:[],type:s.type},resolver:L(W)}),c=l.handleSubmit(n(o));return t.jsx(m.Form,{form:l,children:t.jsxs(T,{onSubmit:c,className:"flex h-full flex-col",children:[t.jsx(m.Body,{children:t.jsx(S,{form:l,ruleType:f,setRulesToRemove:a,rulesToRemove:o,promotion:s})}),t.jsx(m.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[t.jsx(m.Close,{asChild:!0,children:t.jsx(v,{size:"small",variant:"secondary",disabled:r,children:d("actions.cancel")})}),t.jsx(v,{size:"small",type:"submit",isLoading:r,children:d("actions.save")})]})})]})})},I=s=>s.field_type==="number"?parseInt(s.values):s.values,O=({promotion:s,rules:f,ruleType:n})=>{const{handleSuccess:r}=V(),{mutateAsync:d}=D(s.id),{mutateAsync:o}=H(s.id,n),{mutateAsync:a}=U(s.id,n),{mutateAsync:l,isPending:c}=k(s.id,n),y=i=>async function(h){const g={},{rules:b=[]}=h,E=b.filter(e=>e.disguised),q=(i==null?void 0:i.filter(e=>e.disguised))||[];for(const e of E)g[e.attribute]=I(e);for(const e of q)g[e.attribute]=null;const x=b.filter(e=>!e.disguised),j=x.filter(e=>!("id"in e)),P=x.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),j.length&&await o({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),i!=null&&i.length&&await a({rule_ids:i.map(e=>e.id).filter(Boolean)}),P.length&&await l({rules:P.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),r()};return t.jsx($,{promotion:s,rules:f,ruleType:n,handleSubmit:y,isSubmitting:c})},te=()=>{var i,h;const s=A();if(!["rules","buy-rules","target-rules"].includes(s.ruleType))throw"invalid page";const{t:n}=_(),r=s.ruleType,d=s.id,o=[],{promotion:a,isPending:l,isError:c,error:y}=B(d);if(a&&(r==="rules"?o.push(...a.rules||[]):r==="target-rules"?o.push(...((i=a==null?void 0:a.application_method)==null?void 0:i.target_rules)||[]):r==="buy-rules"&&o.push(...((h=a.application_method)==null?void 0:h.buy_rules)||[])),c)throw y;return t.jsxs(m,{children:[t.jsx(m.Header,{children:t.jsx(C,{children:n(`promotions.edit.${r}.title`)})}),!l&&a&&t.jsx(O,{promotion:a,rules:o,ruleType:r})]})};export{te as Component};
