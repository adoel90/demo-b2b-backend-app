import{b as H,u as re,S as oe,C as te,a as G}from"./chunk-VTDYXPA4-Q7WxGpX7.js";import{C as V,S as ae}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as ce}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as W}from"./chunk-HFB3OQXI-Br_N09Gz.js";import{C as J}from"./chunk-2PMSBTXI-C605Uas7.js";import{D as le}from"./chunk-53RYGJCD-DXB7Y3XS.js";import{S as pe}from"./chunk-D7H6ZNK4-D9iVGeOV.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as de}from"./chunk-6HTZNHPT-BKdNZ39U.js";import{R as w,u as Y,a as ue,S as me}from"./chunk-4TC5YS65-BGqqLRkQ.js";import{W as he,a6 as fe,bf as ge,aB as Z,j as e,r as O,b as ee,ad as xe,ae as _e,a7 as A,v as se,fy as je,t as Q,B as K,ah as z,a9 as y,s as U,H as ye,J as be,w as r,I as Ce,D as Se,h as ve,l as Oe,m as Pe,a8 as we,ey as Le,ai as X}from"./index-4Ied8IC1.js";import{b as Ee}from"./chunk-GRT22PE5-D2IPiYnA.js";import{P}from"./progress-tabs-R1bnXREl.js";import{R as q}from"./radio-group-BU1QDlrX.js";import{S as k}from"./select-DlNwCHAx.js";import"./chunk-PDWBYQOW-Dmlh1vBq.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./Trans-DnzIgHzN.js";import"./currency-input-GNUjO7ni.js";import"./_isIndex-DsugWQkN.js";import"./checkbox-B2rxS7f_.js";import"./prompt--C1KvlU1.js";var Te=({form:c,isReturn:h=!1,zone:_,locationId:b,fulfillmentProviderOptions:u,selectedProviderId:x,type:j})=>{const{t}=ee(),p=j==="pickup",d=W({queryFn:s=>U.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(o=>({label:o.name,value:o.id}))}),i=W({queryFn:s=>U.admin.fulfillmentProvider.list({...s,stock_location_id:b}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(o=>({label:ce(o.id),value:o.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(ye,{children:t(`stockLocations.shippingOptions.create.${p?"pickup":h?"returns":"shipping"}.header`,{zone:_.name})}),e.jsx(be,{size:"small",className:"text-ui-fg-subtle",children:t(`stockLocations.shippingOptions.create.${h?"returns":p?"pickup":"shipping"}.hint`)})]}),!p&&e.jsx(r.Field,{control:c.control,name:"price_type",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(r.Control,{children:e.jsxs(q,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(q.ChoiceBox,{className:"flex-1",value:"flat",label:t("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(q.ChoiceBox,{className:"flex-1",value:"calculated",label:t("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(r.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(r.Field,{control:c.control,name:"name",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("fields.name")}),e.jsx(r.Control,{children:e.jsx(Ce,{...s})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:c.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.profile")}),e.jsx(r.Control,{children:e.jsx(J,{...s,options:d.options,searchValue:d.searchValue,onSearchValueChange:d.onSearchValueChange,disabled:d.disabled})}),e.jsx(r.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(r.Field,{control:c.control,name:"provider_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{tooltip:t("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:t("stockLocations.shippingOptions.fields.provider")}),e.jsx(r.Control,{children:e.jsx(J,{...s,onChange:o=>{s.onChange(o),c.setValue("fulfillment_option_id","")},options:i.options,searchValue:i.searchValue,onSearchValueChange:i.onSearchValueChange,disabled:i.disabled})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:c.control,name:"fulfillment_option_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(r.Control,{children:O.createElement(k,{...s,onValueChange:s.onChange,disabled:!x,key:x},e.jsx(k.Trigger,{ref:s.ref,children:e.jsx(k.Value,{})}),e.jsx(k.Content,{children:u==null?void 0:u.filter(o=>!!o.is_return===h).map(o=>e.jsx(k.Item,{value:o.id,children:o.name||o.id},o.id))}))}),e.jsx(r.ErrorMessage,{})]})})]}),e.jsx(Se,{}),e.jsx(pe,{control:c.control,name:"enabled_in_store",label:t("stockLocations.shippingOptions.fields.enableInStore.label"),description:t("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},ke=({form:c,type:h})=>{const _=h==="pickup",{getIsOpen:b,setIsOpen:u}=ue(),[x,j]=O.useState(null),t=a=>{u(V,!0),j(a)},p=()=>{u(V,!1),j(null)},{store:d,isLoading:i,isError:s,error:o}=ve(),f=O.useMemo(()=>{var a;return((a=d==null?void 0:d.supported_currencies)==null?void 0:a.map(S=>S.currency_code))||[]},[d]),{regions:g,isLoading:N,isError:F,error:L}=Oe({fields:"id,name,currency_code",limit:999}),{price_preferences:R}=Pe({}),{setCloseOnEscape:$}=Y(),I=se({control:c.control,name:"name"}),D=re({name:I,currencies:f,regions:g,pricePreferences:R}),n=i||!d||N||!g,C=O.useMemo(()=>[[...f||[],...g||[]]],[f,g]);if(O.useEffect(()=>{!n&&_&&(f.length>0&&f.forEach(a=>{c.setValue(`currency_prices.${a}`,"0")}),g.length>0&&g.forEach(a=>{c.setValue(`region_prices.${a.id}`,"0")}))},[n,_]),s)throw o;if(F)throw L;return e.jsx(me,{id:V,onOpenChangeCallback:a=>{a||j(null)},children:e.jsx(oe,{onOpenConditionalPricesModal:t,onCloseConditionalPricesModal:p,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(le,{isLoading:n,data:C,columns:D,state:c,onEditingChange:a=>$(!a),disableInteractions:b(V)}),x&&e.jsx(te,{info:x,variant:"create"})]})})})},ie=A({name:y().min(1),price_type:Le(ae),enabled_in_store:we(),shipping_profile_id:y().min(1),provider_id:y().min(1),fulfillment_option_id:y().min(1)}),Ne=A({conditional_region_prices:z(y(),X(G).optional()),conditional_currency_prices:z(y(),X(G).optional())}),Fe=A({region_prices:z(y(),y().optional()),currency_prices:z(y(),y().optional())}).merge(ie).merge(Ne);function Ie({zone:c,isReturn:h,locationId:_,type:b}){var I,D;const[u,x]=O.useState("details"),[j,t]=O.useState(!1),{t:p}=ee(),{handleSuccess:d}=Y(),i=xe({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:_e(Fe)}),s=se({control:i.control,name:"provider_id"}),{fulfillment_options:o}=je(s,{enabled:!!s}),f=i.watch("price_type")==="calculated",{mutateAsync:g,isPending:N}=Ee(),F=i.handleSubmit(async n=>{const C=Object.entries(n.currency_prices).map(([l,m])=>{if(m)return{currency_code:l,amount:M(m)}}).filter(l=>!!l),a=Object.entries(n.region_prices).map(([l,m])=>{if(m)return{region_id:l,amount:M(m)}}).filter(l=>!!l),S=Object.entries(n.conditional_region_prices).flatMap(([l,m])=>{const v=(m==null?void 0:m.map(T=>({region_id:l,amount:M(T.amount),rules:H(T)})))||[];return v==null?void 0:v.filter(Boolean)}),E=Object.entries(n.conditional_currency_prices).flatMap(([l,m])=>{const v=(m==null?void 0:m.map(T=>({currency_code:l,amount:M(T.amount),rules:H(T)})))||[];return v==null?void 0:v.filter(Boolean)}),B=[...C,...E,...a,...S],ne=o==null?void 0:o.find(l=>l.id===n.fulfillment_option_id);await g({name:n.name,price_type:n.price_type,service_zone_id:c.id,shipping_profile_id:n.shipping_profile_id,provider_id:n.provider_id,prices:B,data:ne,rules:[{value:h?"true":"false",attribute:"is_return",operator:"eq"},{value:n.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type:{label:"Type label",description:"Type description",code:"type-code"}},{onSuccess:({shipping_option:l})=>{Q.success(p(`stockLocations.shippingOptions.create.${h?"returns":"shipping"}.successToast`,{name:l.name})),d(`/settings/locations/${_}`)},onError:l=>{Q.error(l.message)}})}),L=n=>{if(n==="pricing"){i.clearErrors();const C=ie.safeParse({...i.getValues()});if(!C.success){const[a,...S]=C.error.errors;for(const E of S){const B=E.path.join(".");i.setError(B,{message:E.message,type:E.code})}i.setError(a.path.join("."),{message:a.message,type:a.code},{shouldFocus:!0}),t(!1);return}t(!0)}x(n)},R=(I=i.getFieldState("currency_prices"))!=null&&I.isDirty||(D=i.getFieldState("region_prices"))!=null&&D.isDirty||u==="pricing"?"in-progress":"not-started",$=j?"completed":"in-progress";return e.jsx(w.Form,{form:i,children:e.jsx(de,{className:"flex h-full flex-col",onSubmit:F,onKeyDown:n=>{const C=n.key==="Enter",a=n.metaKey||n.ctrlKey,S=u!=="pricing"&&!f;if(C&&(n.preventDefault(),!!a)){if(S){n.stopPropagation(),L("pricing");return}F()}},children:e.jsxs(P,{value:u,className:"flex h-full flex-col overflow-hidden",onValueChange:n=>L(n),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:$,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.details")})}),!f&&e.jsx(P.Trigger,{value:"pricing",status:R,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(Te,{form:i,zone:c,isReturn:h,type:b,locationId:_,fulfillmentProviderOptions:o||[],selectedProviderId:s})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(ke,{form:i,type:b})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(K,{variant:"secondary",size:"small",children:p("actions.cancel")})}),u==="pricing"||f?e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:N,type:"submit",children:p("actions.save")},"submit-btn"):e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:N,onClick:()=>L("pricing"),type:"button",children:p("actions.continue")},"continue-btn")]})})]})})})}var De="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function rs(){var o,f;const{location_id:c,fset_id:h,zone_id:_}=he(),[b]=fe(),u=b.has("is_return"),{stock_location:x,isPending:j,isFetching:t,isError:p,error:d}=ge(c,{fields:De}),i=(o=x==null?void 0:x.fulfillment_sets)==null?void 0:o.find(g=>g.id===h);if(!j&&!t&&!i)throw Z({message:`Fulfillment set with ID ${h} was not found`},404);const s=(f=i==null?void 0:i.service_zones)==null?void 0:f.find(g=>g.id===_);if(!j&&!t&&!s)throw Z({message:`Service zone with ID ${_} was not found`},404);if(p)throw d;return e.jsx(w,{prev:`/settings/locations/${c}`,children:s&&e.jsx(Ie,{zone:s,isReturn:u,locationId:c,type:i.type})})}export{rs as Component};
